# Cron Jobs Documentation

This document explains the automated background jobs (cron jobs) used in the Blue Ice CRM system.

## Overview

The system uses scheduled tasks to:
1. **Aggregate daily statistics** - Compile order, revenue, and driver performance metrics
2. **Clean up old location data** - Remove location history older than 30 days
3. **Update driver performance metrics** - Calculate daily performance scores for drivers

## Daily Stats Aggregation

### What it does

The daily stats aggregation job runs every night at midnight and:

- Aggregates all completed orders for the day
- Calculates total revenue, cash collected, and delivery charges
- Counts bottles delivered and collected
- Tracks new customers added
- Calculates active driver count
- Computes total distance traveled by all drivers
- Updates driver performance metrics (completion rate, hours active, performance score)
- Cleans up location history older than 30 days

### Setup

#### Option 1: Vercel Cron (Recommended for Vercel deployments)

1. The `vercel.json` file is already configured with the cron schedule
2. Add the `CRON_SECRET` environment variable in your Vercel project settings
3. Deploy your application - Vercel will automatically run the cron job daily at midnight UTC

```json
{
  "crons": [
    {
      "path": "/api/cron/aggregate-stats",
      "schedule": "0 0 * * *"
    }
  ]
}
```

**Note**: Vercel Cron is only available on Pro and Enterprise plans.

#### Option 2: External Cron Service (e.g., cron-job.org, EasyCron)

1. Sign up for a cron service like [cron-job.org](https://cron-job.org)
2. Create a new cron job with:
   - **URL**: `https://your-domain.com/api/cron/aggregate-stats`
   - **Method**: POST
   - **Schedule**: Daily at midnight (`0 0 * * *`)
   - **Headers**:
     ```
     Authorization: Bearer YOUR_CRON_SECRET
     Content-Type: application/json
     ```
3. Replace `YOUR_CRON_SECRET` with the value from your `.env` file

#### Option 3: Server Cron Job (for self-hosted deployments)

Add to your server's crontab:

```bash
# Open crontab editor
crontab -e

# Add this line (replace with your actual domain and secret)
0 0 * * * curl -X POST https://your-domain.com/api/cron/aggregate-stats \
  -H "Authorization: Bearer YOUR_CRON_SECRET" \
  -H "Content-Type: application/json"
```

### Environment Variables

Add this to your `.env` file:

```env
CRON_SECRET=generate-with-openssl-rand-hex-32
```

Generate a secure secret:
```bash
openssl rand -hex 32
```

### API Endpoint

**Endpoint**: `POST /api/cron/aggregate-stats`

**Authentication**: Requires `Authorization: Bearer {CRON_SECRET}` header

**Query Parameters**:
- `date` (optional): Specific date to aggregate in YYYY-MM-DD format
- `backfill` (optional): Number of days (1-90) to backfill historical data

**Examples**:

```bash
# Aggregate today's stats
curl -X POST https://your-domain.com/api/cron/aggregate-stats \
  -H "Authorization: Bearer YOUR_CRON_SECRET"

# Aggregate a specific date
curl -X POST "https://your-domain.com/api/cron/aggregate-stats?date=2024-01-15" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"

# Backfill last 7 days
curl -X POST "https://your-domain.com/api/cron/aggregate-stats?backfill=7" \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

**Response**:

```json
{
  "success": true,
  "message": "Daily statistics aggregated successfully",
  "results": [
    {
      "date": "2024-01-15",
      "ordersCompleted": 45,
      "revenue": 125000,
      "cashCollected": 120000,
      "bottlesDelivered": 180,
      "activeDrivers": 8
    }
  ],
  "cleanup": {
    "deletedRecords": 1523
  }
}
```

## Database Tables

### DailyStats

Stores aggregated daily statistics:

| Field | Type | Description |
|-------|------|-------------|
| date | Date | The date for these stats |
| totalRevenue | Decimal | Total revenue from completed orders |
| cashCollected | Decimal | Cash collected by drivers |
| ordersCompleted | Int | Number of completed orders |
| ordersCreated | Int | Number of orders created |
| ordersCancelled | Int | Number of cancelled orders |
| bottlesDelivered | Int | Total bottles delivered |
| bottlesCollected | Int | Total empty bottles collected |
| newCustomers | Int | New customers added |
| activeDrivers | Int | Number of drivers who completed orders |
| totalDistanceTraveled | Float | Total km traveled by all drivers |
| averageOrderValue | Float | Average revenue per order |

### DriverPerformanceMetrics

Stores per-driver daily performance:

| Field | Type | Description |
|-------|------|-------------|
| driverId | String | Driver ID |
| date | Date | The date for these metrics |
| ordersCompleted | Int | Orders completed by driver |
| ordersAssigned | Int | Total orders assigned to driver |
| totalRevenue | Float | Revenue generated by driver |
| cashCollected | Float | Cash collected by driver |
| bottlesDelivered | Int | Bottles delivered by driver |
| bottlesCollected | Int | Empty bottles collected by driver |
| distanceTraveled | Float | Distance traveled (meters) |
| hoursActive | Float | Hours driver was on duty |
| completionRate | Float | Percentage of assigned orders completed |
| performanceScore | Float | Overall performance score (0-100) |

## Performance Score Calculation

The performance score is calculated using a weighted formula:

```
Performance Score =
  (Completion Rate × 40%) +
  (Productivity × 30%) +
  (Activity × 20%) +
  (Efficiency × 10%)

Where:
- Completion Rate = (Orders Completed / Orders Assigned) × 100
- Productivity = (Orders per Hour / 10) × 100 (capped at 100)
- Activity = (Hours Active / 8) × 100 (capped at 100)
- Efficiency = 100 - ((Distance per Order / 5000) × 100) (minimum 0)
```

## Data Retention

- **Location History**: 30 days (cleaned up automatically)
- **DailyStats**: Retained indefinitely
- **DriverPerformanceMetrics**: Retained indefinitely

## Monitoring

Check cron job execution:

```bash
# View logs on Vercel
vercel logs --follow

# Manual test of endpoint
curl -X GET https://your-domain.com/api/cron/aggregate-stats \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

## Troubleshooting

### Cron job not running

1. Verify `CRON_SECRET` is set in environment variables
2. Check that the cron schedule is correct (use [crontab.guru](https://crontab.guru) to verify)
3. Review application logs for errors
4. Test the endpoint manually using curl

### Missing data in DailyStats

1. Run a manual aggregation for the specific date:
   ```bash
   curl -X POST "https://your-domain.com/api/cron/aggregate-stats?date=YYYY-MM-DD" \
     -H "Authorization: Bearer YOUR_CRON_SECRET"
   ```

2. Use backfill for multiple days:
   ```bash
   curl -X POST "https://your-domain.com/api/cron/aggregate-stats?backfill=7" \
     -H "Authorization: Bearer YOUR_CRON_SECRET"
   ```

### Unauthorized errors

1. Verify `CRON_SECRET` matches between `.env` and your cron service
2. Check that the Authorization header is properly formatted: `Bearer {secret}`
3. Ensure the secret doesn't contain special characters that need escaping

## Best Practices

1. **Run at off-peak hours**: Schedule for midnight or early morning when traffic is low
2. **Monitor execution**: Set up alerts for failed cron jobs
3. **Regular backups**: Daily stats are valuable business data - back them up
4. **Test before deploying**: Always test cron endpoints manually before setting up automation
5. **Secure your secret**: Never commit `CRON_SECRET` to version control

## Future Enhancements

Potential additions to the cron system:

- Weekly summary reports via email
- Monthly performance analytics
- Automated alerts for anomalies (e.g., sudden drop in orders)
- Customer engagement metrics (churn rate, retention)
- Inventory forecasting based on historical trends
